<html>
	<head>
		<script src='http://127.0.0.1:8000/AirChat/AirChat.html'></script>
        <title>Airãƒãƒ£ãƒ?ƒˆ</title>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <link href="style.css" rel="stylesheet" type="text/css"/>
        <link href="modal.css" rel="stylesheet" type="text/css"/>
		<link rel="stylesheet" href="farbtastic.css" type="text/css" />

        <script type="text/javascript" src="lib/air/AIRAliases.js"></script>
        <script type="text/javascript" src="lib/modal.js" charset="UTF-8"></script>
		<script type="text/javascript" src="lib/security.js" charset="UTF-8"></script>
        <script type="text/javascript" src="lib/jquery-1.3.2.min.js" ></script>
		<script type="text/javascript" src="lib/farbtastic.js"></script>
        <script type="text/javascript" src="lib/airchat-xmlsoket.js" charset="UTF-8"></script>

        <script type="text/javascript">
            // AIR-related functions created by the developer
			var myMsgNum = 0;
			var myHandleName="";
			var myColor="#ffffff";
			var myUniqueKey="";
			var myImgMap=new Array();
			/**
			 * ã‚­ãƒ¼å…¥åŠ›æ™‚ã® EnterKey ãƒã‚§ãƒ?‚¯
			 * æœ¬ãƒ¡ã‚½ãƒ?ƒ‰ã§ã¯ã€ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼æŠ¼ä¸‹æ™‚ã«ã€ãƒ¡ãƒ?‚»ãƒ¼ã‚¸ã‚’é?ä¿¡ã—ã?å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã?
			 * @param {Object} kcode
			 */
			function inputKeyPress(kcode){
				if(kcode != 13) return; 
				var elm = document.getElementById("msg");
				//XSSå¯¾ç­?
				var sanitizeMsg = sanitizeXSS(elm.value);
				sendMessage(sanitizeMsg);
				// å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹
				elm.value="";
			}
			/**
			 * ãƒ¡ãƒ?‚»ãƒ¼ã‚¸ã®é€ä¿¡
			 * @param {Object} msgã€?ƒ¡ãƒ?‚»ãƒ¼ã‚¸
			 */
			function sendMessage(msg) {
				if(msg.length == 0 )return;
				myMsgNum++;
				var mod2 = myMsgNum % 2;
				var wkmsg = "<div style='color:"+myColor+ "' class='msg0'>"+myMsgNum + ":" +myHandleName+">"+msg+"</div>";
				//ã‚½ã‚±ãƒ?ƒˆç”¨ãƒ¡ãƒ?‚»ãƒ¼ã‚¸ã®é€ä¿¡
				sendSocketMessage(wkmsg);
			}
			/**
			 * åˆæœŸç”»é¢ã¸?ˆç™»éŒ²ç”»é¢è¡¨ç¤º??
			 */
			function init(){
				dispModalbox();
			}

			/**
			 * HNç™»éŒ²
			 */
			function registHN(){
				// æ–?­—ã?è‰²ã®å–å¾?
				var colorElm = document.getElementById("color");
				myColor = colorElm.value;
				// HNã®å–å¾?
				var elm = document.getElementById("handleName");
				var bkupHN = myHandleName;
				if ( elm.value.length > 0) {
					//XSSå¯¾ç­?
					var sanitizeName = sanitizeXSS(elm.value);
					myHandleName = sanitizeName;
				} else {
					myHandleName = "åç„¡ã?;
				}
				closeModalbox();
				
	
				if (bkupHN != myHandleName) {
					// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå›ºæœ‰ã?ãƒ??ã‚¿ã‚’ä½œæ?ã™ã‚‹
					var now = new Date();
					var year = now.getYear(); // å¹´
					if(year < 2000) { year += 1900; }
					var month = now.getMonth() + 1; // æœ?
					var day = now.getDate(); // æ—¥
					var hour = now.getHours(); // æ™?
					var min = now.getMinutes(); // åˆ?
					var sec = now.getSeconds(); // ç§?
					myUniqueKey=""+year+month+day+hour+min+sec;
					
					//ãƒãƒ£ãƒ?ƒˆã‚µãƒ¼ãƒã?ã¸æ¥ç¶?
					conectChatServer();
				}
			}
			
			/**
			 * ãƒãƒ£ãƒ?ƒˆã‚µãƒ¼ãƒã?ã¸æ¥ç¶?
			 */
			function conectChatServer(){
				connectSocketServer("www.ãƒãƒ£ãƒ?ƒˆã‚µãƒ¼ãƒã?URL",49153);
			}

			/**
			 * ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ã®è¨­å®?
			 */
			$(document).ready(function() {
    			$('#demo').hide();
    			$('#picker').farbtastic('#color');
 			});

			// closeã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒ?ƒã™ã‚‹
			window.nativeWindow.addEventListener(air.Event.CLOSING, onClosingEvent);
			
			/**
			 * ã‚¯ãƒ­ãƒ¼ã‚ºæ™‚ã?ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé?å‡ºãƒ¡ãƒ?‚»ãƒ¼ã‚¸ã®é€ä¿¡??
			 */
			function onClosingEvent(){
				if ( myHandleName == "") return;
				var msg = myHandleName + "ã¯é€??ã•ã‚Œã¾ã—ãŸã€?;
				sendSocketMessage(msg);
			}
			
			/**
			 * bodyã€?‚’ãƒ‰ãƒ­ãƒ??ã®ã‚¿ãƒ¼ã‚²ãƒ?ƒˆã«ã™ã‚‹
			 * @param {Object} event
			 */
			function doDragEnter(event) {
				event.preventDefault();				
			}
			/**
			 * ãƒ‰ãƒ©ãƒ?‚°ã‚ªãƒ¼ãƒã?æ™‚ã?ãƒ?ƒ•ã‚©ãƒ«ãƒˆå?ç?‚’ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã§ã€body ã‚’ãƒ‰ãƒ­ãƒ??ã‚¿ãƒ¼ã‚²ãƒ?ƒˆã«ã™ã‚‹
			 * @param {Object} event
			 */
			function doDragOver(event){
				event.preventDefault();
			}
			/**
			 * dragleaveæ™‚ã?ãƒ?ƒ•ã‚©ãƒ«ãƒˆå?ç?‚’ç„¡åŠ¹ã«ã™ã‚‹ã“ã¨ã§ã€body ã‚’ãƒ‰ãƒ­ãƒ??ã‚¿ãƒ¼ã‚²ãƒ?ƒˆã«ã™ã‚‹
			 * @param {Object} event
			 */
			function doDragLeave(event){
				event.preventDefault();
			}

			/**
			 * ãƒ‰ãƒ­ãƒ??æ™‚ã?å‡¦ç?
			 * @param {Object} event
			 */
			function doDrop( event ) {
				var fileList = event.dataTransfer.getData("application/x-vnd.adobe.air.file-list");
				if ( fileList.length <= 0 ) return;
				if ( fileList.length > 4 ) {
					alert("ç”»åƒã?åŒæ™‚ã«?”ã¤ã¾ã§ã«ã—ã¦ä¸‹ã•ã??");
					return;
				}
				
				for ( var cnt = 0;cnt < fileList.length; cnt++ ) {
					var filename = fileList[cnt].url;
					//ç”»åƒä»¥å¤–ã?é€ä¿¡ä»˜åŠ 
					if ( !doUploadChack(filename) ) {
						alert("ç”»åƒã ã‘ã«ã—ã¦ä¸‹ã•ã??");
						return;
					}
					var unique = myUniqueKey + myMsgNum + cnt;
					upload(filename,unique);
				}
			}

			/**
			 * ã‚¢ãƒ??ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹ã®ãƒã‚§ãƒ?‚¯
			 * @param {Object} filenameã€?ƒ•ã‚¡ã‚¤ãƒ«å?
			 */			
			function doUploadChack(filename){
				var idx = filename.indexOf(".");
				if ( idx < 0 ) return false;
				var type = filename.substring(idx+1);
				type = type.toUpperCase();
				if ( type == "JPEG" || type == "JPG" || type == "PNG" ||
					 type == "GIF" || type == "BMP" || type == "TIF" || type == "TIFF") {
					 	return true;
				}
				return false;
			}

			/**
			 * ã‚¢ãƒ??ãƒ­ãƒ¼ãƒ?
			 * æ—¥æœ¬èªå¯¾ç­?
			 * ã€??Apacheã¯æ—¥æœ¬èªãƒ•ã‚¡ã‚¤ãƒ«ã®å‚ç?ã?¾ãã„ã‹ãªã??ã§ã€??ä¿¡æ™‚ï¼šã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå›ºæœ‰ã?ãƒ??ã‚¿IDã‚’é?ä¿¡ã?
			 * ã€??ãã?å¾Œã?ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå›ºæœ‰ã?ãƒ??ã‚¿IDã«ã¦ã€Servletã¸GETã§æ¥ç¶šã—ã€XMLãƒ??ã‚¿ã‚’å—ä¿¡ã™ã‚‹
			 * ã€??ã‚µãƒ¼ãƒã?ã§ã¯ã€ã‚¢ãƒ??ãƒ­ãƒ¼ãƒ‰æ™‚ã€ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç‹¬è‡ªã®ãƒ«ãƒ¼ãƒ«ã§ä½œæ?ã™ã‚‹ã€?
			 * ã€??ãã?å¾Œã?ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå›ºæœ‰ã?ãƒ??ã‚¿IDã«ã¦ã€Servletã¸GETã§æ¥ç¶šã—ãŸã‚‰ã€XMLãƒ??ã‚¿ã‚’è¿”ã™
			 * @param filepath ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
			 * @param dateID ãƒ??ã‚¿å›ºæœ‰ã?ID
			 */
			function upload(filepath,dateID) {
				// ãƒ•ã‚¡ã‚¤ãƒ«ã‚ªãƒ•ã˜ã?ã¨ç”Ÿæ?
				var fileObject = new air.File(filepath);
				
				// å?¨®ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ²
				fileObject.addEventListener(air.Event.COMPLETE, completeUploadHandler);
				fileObject.addEventListener(air.IOErrorEvent.IO_ERROR,ioErrorHandler);
				fileObject.addEventListener(air.ProgressEvent.PROGRESS, progressHandler);
				
				// ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™»éŒ² 
    	        var url = "http://www.Uploadç”¨ã‚µãƒ¼ãƒã?URL/FileUploader/Uploader?id="+dateID;
				// æ—¥æœ¬èªå¯¾ç­–ã§ã€åå‰ã¨ãƒ??ã‚¿ã‚’é–¢é€£ã¤ã‘ã¦ãŠã
				myImgMap[fileObject.name] = dateID;
	            var request = new air.URLRequest(url);
        	    request.method = air.URLRequestMethod.POST;
				fileObject.upload(request);
	        }

			/**
			 * é€ä¿¡å®Œäº?™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ¡ã‚½ãƒ?ƒ‰
			 * @param {Object} event
			 */
			function completeUploadHandler(event) 
			{ 
			    air.trace("...complete..."); 
				var filename = event.target.name;
				var dataID = myImgMap[filename];
				// ãƒªã‚¯ã‚¨ã‚¹ãƒˆç™»éŒ² 
    	        var url = "http://www.Uploadç”¨ã‚µãƒ¼ãƒã?URL/FileUploader/Uploader?id="+dataID;
				
				// ã‚¨ãƒ³ã‚³ãƒ¼ãƒ?
				var uri = encodeURI(url);
	            var request = new air.URLRequest(uri);
        	    request.method = air.URLRequestMethod.GET;
				var loader = new air.URLLoader();
				loader.addEventListener(air.Event.COMPLETE,completeGetHandler);
				loader.load(request);
				

			}

			/**
			 * ãƒ•ã‚¡ã‚¤ãƒ«ãƒ?‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®Getãƒãƒ³ãƒ‰ãƒ©ãƒ¼
			 * @param {Object} event
			 */
			function completeGetHandler(event) {
				//XMlãƒ??ã‚¿å—ä¿¡				
				var xmldata = event.target.data;
				// ãƒ?‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ‘ã‚¹(URL)ã‚’å–å¾—ã™ã‚?
				var dlkey="<download>";
				var sttidx = xmldata.indexOf(dlkey);
				var endidx = xmldata.indexOf("</download>");
				var url = xmldata.substring(sttidx+dlkey.length,endidx);
				myMsgNum++;
				var wkmsg = "<div style='color:"+myColor+ "' class='msg0'>"+myMsgNum + ":" +myHandleName+">";
				var msg = "<img src='"+url+"'/></div>";
				//ã‚½ã‚±ãƒ?ƒˆç”¨ãƒ¡ãƒ?‚»ãƒ¼ã‚¸ã®é€ä¿¡
				sendSocketMessage(wkmsg+msg);
			}
			
			/**
			 * é€ä¿¡å¤±æ•—æ™‚
			 * @param {Object} event
			 */
			function ioErrorHandler(event){
			    air.trace("...ioError..."); 
			}
			/**
			 * ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
			 * @param {Object} event
			 */
			function progressHandler(event) {
            	air.trace("bytesLoaded=" + event.bytesLoaded + "; bytesTotal=" + event.bytesTotal);
	        }
        </script>
	</head>


    <body bgcolor="black" text="white" onload="init()" 
	      ondragenter="doDragEnter(event)"
		  ondragover="doDragOver(event)"
		  ondragleave="doDragLeave(event)"
		  ondrop="doDrop(event)">
	<!-- ãƒãƒ£ãƒ?ƒˆç”»é¢ -->
	<button onclick="dispModalbox()">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</button>
    	<div id="chat">
    		<div class="log">
    			<table border="2" width="515" height="400">
    				<tr>
    					<td valign="top"><div id="str"></div></td>
    				</tr>
   			 	</table>
			</div>
			<input id="msg" type="text" size="50" onkeypress="return inputKeyPress(event.keyCode);"/> 
    	</div>

	<!-- ä»¥ä¸‹ã?åˆæœŸç”»é¢ã®ç™»éŒ²ç”»é¢ -->
	<div id="overlay">
	<div id="modalbox">
		<br>
		ãƒãƒ³ãƒ‰ãƒ«ãƒã?ãƒ??ç™»éŒ²ã€?input id="handleName" type="text" size="20" />
		
		<!-- ã‚«ãƒ©ãƒ¼ãƒ”ãƒƒã‚«ãƒ¼ -->		
		<div id="demo" style="color: red; font-size: 1.4em">jQuery.js is not present. You must install jQuery in this folder for the demo to work.</div>
		<form action="" style="width: 400px;">
  			<div class="form-item"><label for="color">æ–?­—ã?è‰²</label><input type="text" id="color" name="color" value="#ffffff" /></div><div id="picker"></div>
		</form>
		<div style="position:relative ; top:-50px; left:-30px;" align=right><button onclick="registHN()">ç™»éŒ²</button></div>
	</div>
	

	</body>
</html>
